<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Music Studio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <button class="btn btn-icon" id="historyBtn" title="Analysis History">üìú</button>
                <div class="theme-switcher-container">
                    <label class="theme-switcher">
                        <input type="checkbox" id="themeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <h1>üé∂ AI Music Studio üé∂</h1>
            <p class="author-info">by T. Pitk√§nen (timbor@saunagames.fi)</p>
            <p>Analyze Audio, Generate Prompts, and Create Music with AI</p>

            <div class="features-list">
                <span class="feature-item">‚ú® AI Music Generation</span>
                <span class="feature-item">üéß Audio Analysis</span>
                <span class="feature-item">üöÄ GPU Accelerated</span>
                <span class="feature-item">üé§ Vocal Separation</span>
                <span class="feature-item">‚úçÔ∏è Lyrics Transcription</span>
            </div>
        </div>

        <div class="card">
            <h2>‚ö° Quick Generation</h2>
            <p>Bypass audio analysis and generate music directly from a prompt.</p>
            <div class="quick-generation-tabs">
                <button class="tab-link active" onclick="openQuickGenTab(event, 'quickGenSimple')">Simple</button>
                <button class="tab-link" onclick="openQuickGenTab(event, 'quickGenAdvanced')">Advanced</button>
            </div>

            <div id="quickGenSimple" class="quick-generation-tab-content active">
                <textarea id="quickGenSimplePrompt" placeholder="e.g., A chill lofi hip hop beat, with a melancholic piano melody..."></textarea>
            </div>

            <div id="quickGenAdvanced" class="quick-generation-tab-content">
                <div class="form-group">
                    <label for="quickGenTitle">Title:</label>
                    <input type="text" id="quickGenTitle" placeholder="e.g., Midnight Rain">
                </div>
                 <div class="prompt-subsection">
                    <div class="prompt-header">
                        <span class="prompt-name-sub">Style of Music</span>
                    </div>
                    <div class="prompt-text">
                        <textarea id="quickGenAdvancedStyle" placeholder="e.g., lofi hip hop, chill, instrumental"></textarea>
                    </div>
                </div>
                <div class="prompt-subsection">
                    <div class="prompt-header">
                        <span class="prompt-name-sub">Lyrics</span>
                    </div>
                    <div class="prompt-text">
                        <textarea id="quickGenAdvancedLyrics" placeholder="[verse]&#x0a;the rain falls softly&#x0a;[chorus]&#x0a;on the window pane"></textarea>
                    </div>
                </div>
                <div class="options-section" style="margin-top: 15px;">
                    <input type="checkbox" id="quickGenInstrumental">
                    <label for="quickGenInstrumental">Instrumental</label>
                </div>
            </div>
            <button class="btn" id="quickGenerateBtn" style="margin-top: 15px;">Generate Music</button>
        </div>

        <div class="card">
            <div class="status-indicator">
                <div class="hardware-info">
                    <span>üñ•Ô∏è CPU: {{ cpu_model }}</span>
                    <span>|</span>
                    <span>üéÆ GPU: {{ gpu_model }}</span>
                </div>
                <div class="acceleration-status">
                    <div>
                        AI Processing (Demucs & Whisper):
                        {% if pytorch_gpu %}<span class="active">‚óè GPU</span>{% else %}<span class="inactive">‚óè CPU</span>{% endif %}
                    </div>
                </div>
            </div>

            <div class="options-grid">
                <div class="options-section">
                    <label for="modelQualitySelect">Transcription Quality:</label>
                    <select id="modelQualitySelect">
                        <option value="tiny">Tiny (Fastest, Multilingual)</option>
                        <option value="tiny.en">Tiny (Fastest, English-Only)</option>
                        <option value="base" selected>Base (Balanced, Multilingual)</option>
                        <option value="base.en">Base (Balanced, English-Only)</option>
                        <option value="small">Small (Good Quality, Multilingual)</option>
                        <option value="small.en">Small (Good Quality, English-Only)</option>
                        <option value="medium">Medium (High Quality, Multilingual)</option>
                        <option value="medium.en">Medium (High Quality, English-Only)</option>
                        <option value="large">Large (Best Quality, Multilingual)</option>
                    </select>
                </div>
                <div class="options-section">
                    <label for="separationQualitySelect">Separation Quality:</label>
                    <select id="separationQualitySelect">
                        <option value="htdemucs_ft" selected>Hybrid Transformer (High Quality)</option>
                        <option value="hdemucs_mmi">Hybrid Demucs (Medium Quality)</option>
                        <option value="mdx_extra">MDX-Extra (Fast)</option>
                    </select>
                </div>
                <div class="options-section">
                    <input type="checkbox" id="saveVocalsCheckbox">
                    <label for="saveVocalsCheckbox">Save Extracted Vocals</label>
                </div>
                <div class="options-section">
                    <label for="genreSelect">Genre for Analysis:</label>
                    <select id="genreSelect">
                        <!-- Genres will be populated dynamically -->
                    </select>
                    <button class="btn btn-secondary" id="addGenreBtn" style="margin-left: 10px;">Add Custom Genre</button>
                    <button class="btn btn-secondary" id="clearBtn" style="margin-left: 10px; display: none;">Clear</button>
                    <button class="btn btn-secondary" id="exportBtn" style="margin-left: 10px; display: none;">Export to JSON</button>
                    <button class="btn btn-secondary" id="saveHistoryBtn" style="margin-left: 10px; display: none;">Save to History</button>
                </div>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üéß</div>
                <div class="upload-text">Drop your audio file here</div>
                <div class="upload-subtext">or click to browse</div>
                <div class="upload-subtext" style="margin-top: 10px;">Supported: MP3, WAV, FLAC, OGG, M4A, AAC</div>
            </div>
            <input type="file" id="fileInput" accept=".mp3,.wav,.flac,.ogg,.m4a,.aac">
            
            <div class="file-info" id="fileInfo"></div>
            <div id="waveform"></div>

            <div class="metadata-container" id="metadataContainer">
                <h2>Quick Info</h2>
                <div class="analysis-grid" id="metadataGrid"></div>
                <button class="btn" id="proceedBtn">Analyze & Generate Prompts</button>
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p id="loadingStatus">Analyzing your audio... This may take a moment.</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>

            <div class="error" id="error"></div>

            <div class="results" id="results">
                <div class="results-header">
                    <h2>üìä Audio Analysis</h2>
                </div>
                <div class="analysis-grid" id="analysisGrid"></div>

                <div class="prompts-section">
                    <h2>‚ú® Generated Prompts</h2>
                    <div class="tabs">
                        <button class="tab-link active" onclick="openTab(event, 'standardPrompts')">Standard</button>
                        <button class="tab-link" onclick="openTab(event, 'creativePrompts')">Creative</button>
                        <button class="tab-link" onclick="openTab(event, 'advancedPrompts')">Advanced</button>
                        <button class="tab-link" onclick="openTab(event, 'sunoGenerations')">Music Generations</button>
                    </div>

                    <div id="standardPrompts" class="tab-content active">
                        <!-- Basic, Detailed, Style-Focused, Tempo-Focused -->
                    </div>
                    <div id="creativePrompts" class="tab-content">
                        <!-- Thematic, Artist Style, Refinement -->
                    </div>
                    <div id="advancedPrompts" class="tab-content">
                        <!-- Advanced Mode -->
                    </div>
                    <div id="sunoGenerations" class="tab-content">
                        <h2>üé∂ Suno Generations</h2>
                        <div id="generationsContainer"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for adding a new genre -->
        <div id="genreModal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2>Add a New Genre Rule</h2>
                <form id="genreForm">
                    <div class="form-group">
                        <label for="genreName">Genre Name:</label>
                        <input type="text" id="genreName" required>
                    </div>
                    <div class="form-group">
                        <label for="minBPM">Minimum BPM:</label>
                        <input type="number" id="minBPM" required>
                    </div>
                    <div class="form-group">
                        <label for="maxBPM">Maximum BPM:</label>
                        <input type="number" id="maxBPM" required>
                    </div>
                    <button type="submit" class="btn">Save Genre</button>
                </form>
            </div>
        </div>
    </div>

    <!-- History Panel -->
    <div id="historyPanel" class="history-panel">
        <button class="close-btn" id="closeHistoryBtn">&times;</button>
        <h2>Analysis History</h2>
        <div id="historyContainer">
            <!-- History items will be populated here -->
        </div>
    </div>

    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>